<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firecrawl Lite - Web Content Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Custom scrollbar for results */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-fire text-blue-600 text-2xl"></i>
                        <h1 class="text-2xl font-bold text-gray-900">Firecrawl Lite</h1>
                    </div>
                    <a href="/docs" target="_blank" class="text-blue-600 hover:text-blue-700 font-medium">
                        <i class="fas fa-book mr-2"></i>API Docs
                    </a>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex">
                        <button id="single-tab" class="tab-button px-6 py-3 border-b-2 border-blue-500 text-blue-600 font-medium text-sm focus:outline-none transition-colors">
                            <i class="fas fa-file-alt mr-2"></i>Single URL
                        </button>
                        <button id="batch-tab" class="tab-button px-6 py-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm focus:outline-none transition-colors">
                            <i class="fas fa-layer-group mr-2"></i>Batch Processing
                        </button>
                        <button id="firecrawl-tab" class="tab-button px-6 py-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm focus:outline-none transition-colors">
                            <i class="fas fa-fire mr-2"></i>Firecrawl API
                        </button>
                        <button id="markitdown-tab" class="tab-button px-6 py-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm focus:outline-none transition-colors">
                            <i class="fab fa-python mr-2"></i>Markitdown
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <!-- Single URL Tab -->
                    <div id="single-content" class="tab-content">
                        <form id="single-form" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    URLs (one per line)
                                </label>
                                <textarea id="urls-input" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="https://example.com&#10;https://another-site.com&#10;https://docs.example.com/guide"></textarea>
                                <p class="mt-1 text-sm text-gray-500">Enter multiple URLs, one per line. They will be processed sequentially with a 1-second delay.</p>
                            </div>

                            <!-- Options -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Format -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Output Format</label>
                                    <select id="format" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="markdown">Markdown</option>
                                        <option value="html">HTML</option>
                                    </select>
                                </div>

                                <!-- Timeout -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Timeout (ms)</label>
                                    <input type="number" id="timeout" value="30000" min="1000" max="60000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>

                                <!-- Save to File -->
                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="saveToFile" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="saveToFile" class="text-sm font-medium text-gray-700">Save to file</label>
                                </div>

                                <!-- Save Directory -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Save Directory</label>
                                    <input type="text" id="saveDirectory" placeholder="Leave empty for date-based folder" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>

                                <!-- Include Options -->
                                <div class="space-y-2">
                                    <label class="flex items-center space-x-3">
                                        <input type="checkbox" id="includeImages" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <span class="text-sm font-medium text-gray-700">Include Images</span>
                                    </label>
                                    <label class="flex items-center space-x-3">
                                        <input type="checkbox" id="includeLinks" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <span class="text-sm font-medium text-gray-700">Include Links</span>
                                    </label>
                                </div>

                                <!-- Wait for Selector -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Wait for Selector (optional)</label>
                                    <input type="text" id="waitForSelector" placeholder=".content, #main-content" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>

                            <!-- Advanced Options -->
                            <div class="border-t pt-6">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Advanced Options</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Wait Time -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Wait Time (ms)</label>
                                        <input type="number" id="waitTime" value="3000" min="1000" max="10000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <p class="mt-1 text-xs text-gray-500">Time to wait for dynamic content after page load</p>
                                    </div>

                                    <!-- Wait Until Strategy -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Wait Until Strategy</label>
                                        <select id="waitUntil" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="networkidle0">Network Idle (0 requests)</option>
                                            <option value="networkidle1">Network Idle (1 request)</option>
                                            <option value="load">Load Event</option>
                                            <option value="domcontentloaded">DOM Content Loaded</option>
                                        </select>
                                    </div>

                                    <!-- Content Detection Options -->
                                    <div class="space-y-2">
                                        <label class="flex items-center space-x-3">
                                            <input type="checkbox" id="waitForContentSelectors" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                            <span class="text-sm font-medium text-gray-700">Smart Content Detection</span>
                                        </label>
                                        <label class="flex items-center space-x-3">
                                            <input type="checkbox" id="scrollToBottom" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                            <span class="text-sm font-medium text-gray-700">Scroll to Trigger Lazy Loading</span>
                                        </label>
                                    </div>

                                    <!-- Max Content Length -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Max Content Length</label>
                                        <input type="number" id="maxContentLength" value="1000000" min="10000" max="5000000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <p class="mt-1 text-xs text-gray-500">Maximum characters to extract</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="flex justify-end">
                                <button type="submit" id="submit-btn" class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                                    <i class="fas fa-play mr-2"></i>Start Extraction
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Batch Tab -->
                    <div id="batch-content" class="tab-content hidden">
                        <div class="text-center py-12">
                            <i class="fas fa-hammer text-gray-400 text-5xl mb-4"></i>
                            <p class="text-gray-500 text-lg">Batch processing coming soon!</p>
                            <p class="text-gray-400 mt-2">Use the Single URL tab with multiple URLs for now.</p>
                        </div>
                    </div>

                    <!-- Firecrawl Tab -->
                    <div id="firecrawl-content" class="tab-content hidden">
                        <form id="firecrawl-form" class="space-y-6">
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                <div class="flex items-start">
                                    <i class="fas fa-fire text-orange-600 mt-1 mr-3"></i>
                                    <div>
                                        <h4 class="text-orange-900 font-medium">Firecrawl API Integration</h4>
                                        <p class="text-orange-700 text-sm mt-1">Uses Firecrawl's advanced crawling capabilities for better content extraction. Requires a valid API key in .env file.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Mode Selection -->
                            <div class="bg-white border border-gray-200 rounded-lg p-4">
                                <label class="block text-sm font-medium text-gray-700 mb-3">Operation Mode</label>
                                <div class="grid grid-cols-3 gap-4">
                                    <label class="firecrawl-mode-option relative border rounded-lg p-3 cursor-pointer hover:border-orange-300 transition-colors">
                                        <input type="radio" name="firecrawl-mode" value="single" checked class="sr-only">
                                        <div class="text-center">
                                            <i class="fas fa-file-alt text-2xl text-gray-600 mb-2"></i>
                                            <p class="font-medium text-sm">Single URL</p>
                                            <p class="text-xs text-gray-500 mt-1">Extract one page</p>
                                        </div>
                                        <div class="firecrawl-mode-indicator absolute inset-0 border-2 border-orange-500 rounded-lg hidden"></div>
                                    </label>
                                    <label class="firecrawl-mode-option relative border rounded-lg p-3 cursor-pointer hover:border-orange-300 transition-colors">
                                        <input type="radio" name="firecrawl-mode" value="batch" class="sr-only">
                                        <div class="text-center">
                                            <i class="fas fa-layer-group text-2xl text-gray-600 mb-2"></i>
                                            <p class="font-medium text-sm">Batch URLs</p>
                                            <p class="text-xs text-gray-500 mt-1">Extract multiple pages</p>
                                        </div>
                                        <div class="firecrawl-mode-indicator absolute inset-0 border-2 border-orange-500 rounded-lg hidden"></div>
                                    </label>
                                    <label class="firecrawl-mode-option relative border rounded-lg p-3 cursor-pointer hover:border-orange-300 transition-colors">
                                        <input type="radio" name="firecrawl-mode" value="map" class="sr-only">
                                        <div class="text-center">
                                            <i class="fas fa-sitemap text-2xl text-gray-600 mb-2"></i>
                                            <p class="font-medium text-sm">Map Website</p>
                                            <p class="text-xs text-gray-500 mt-1">Extract all URLs</p>
                                        </div>
                                        <div class="firecrawl-mode-indicator absolute inset-0 border-2 border-orange-500 rounded-lg hidden"></div>
                                    </label>
                                </div>
                            </div>

                            <!-- Dynamic Content Area -->
                            <div id="firecrawl-dynamic-content">
                                <!-- Single URL Mode (default) -->
                                <div id="firecrawl-single-mode" class="firecrawl-mode-content">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            URL to Extract
                                        </label>
                                        <input type="url" id="firecrawl-single-url" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors" placeholder="https://docs.example.com/guide">
                                    </div>
                                </div>

                                <!-- Batch URLs Mode -->
                                <div id="firecrawl-batch-mode" class="firecrawl-mode-content hidden">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            URLs to Extract (one per line)
                                        </label>
                                        <textarea id="firecrawl-batch-urls" rows="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors" placeholder="https://example.com/page1&#10;https://example.com/page2&#10;https://example.com/page3"></textarea>
                                        <p class="mt-1 text-sm text-gray-500">Enter multiple URLs, one per line. Maximum 25 URLs per batch.</p>
                                    </div>
                                </div>

                                <!-- Map Website Mode -->
                                <div id="firecrawl-map-mode" class="firecrawl-mode-content hidden">
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Website URL to Map
                                            </label>
                                            <input type="url" id="firecrawl-map-url" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors" placeholder="https://example.com">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Search Filter (optional)
                                            </label>
                                            <input type="text" id="firecrawl-map-search" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors" placeholder="e.g., docs, api, guide">
                                            <p class="mt-1 text-sm text-gray-500">Filter URLs containing specific keywords</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Limit (optional)
                                            </label>
                                            <input type="number" id="firecrawl-map-limit" min="1" max="1000" placeholder="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Firecrawl Options -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Format -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Output Formats</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center space-x-3">
                                            <input type="checkbox" id="firecrawl-markdown" checked class="w-4 h-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                                            <span class="text-sm font-medium text-gray-700">Markdown</span>
                                        </label>
                                        <label class="flex items-center space-x-3">
                                            <input type="checkbox" id="firecrawl-html" class="w-4 h-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                                            <span class="text-sm font-medium text-gray-700">HTML</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Wait Time -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Wait Time (ms)</label>
                                    <input type="number" id="firecrawl-waitFor" value="3000" min="1000" max="30000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>

                                <!-- Content Options -->
                                <div class="space-y-2">
                                    <label class="flex items-center space-x-3">
                                        <input type="checkbox" id="firecrawl-onlyMainContent" checked class="w-4 h-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                                        <span class="text-sm font-medium text-gray-700">Only Main Content</span>
                                    </label>
                                    <label class="flex items-center space-x-3">
                                        <input type="checkbox" id="firecrawl-screenshot" class="w-4 h-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                                        <span class="text-sm font-medium text-gray-700">Include Screenshot</span>
                                    </label>
                                </div>

                                <!-- Timeout -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Timeout (ms)</label>
                                    <input type="number" id="firecrawl-timeout" value="30000" min="5000" max="60000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>

                                <!-- Save Options -->
                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="firecrawl-saveToFile" class="w-4 h-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                                    <label for="firecrawl-saveToFile" class="text-sm font-medium text-gray-700">
                                        <span id="firecrawl-save-label">Save to file</span>
                                    </label>
                                </div>

                                <!-- Save Directory -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Save Directory</label>
                                    <input type="text" id="firecrawl-saveDirectory" placeholder="Leave empty for date-based folder" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                            </div>

                            <!-- Advanced Tags -->
                            <div class="border-t pt-6">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Advanced Tag Filtering</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Include Tags -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Include Tags (optional)</label>
                                        <input type="text" id="firecrawl-includeTags" placeholder="article, main, .content" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                        <p class="mt-1 text-xs text-gray-500">Comma-separated list of tags/selectors to include</p>
                                    </div>

                                    <!-- Exclude Tags -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Exclude Tags</label>
                                        <input type="text" id="firecrawl-excludeTags" value="nav, footer, header, .sidebar" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                        <p class="mt-1 text-xs text-gray-500">Comma-separated list of tags/selectors to exclude</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="flex justify-end">
                                <button type="submit" id="firecrawl-submit-btn" class="px-6 py-3 bg-orange-600 text-white font-medium rounded-lg hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-colors">
                                    <i class="fas fa-fire mr-2"></i><span id="firecrawl-submit-text">Extract with Firecrawl</span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Markitdown Tab -->
                    <div id="markitdown-content" class="tab-content hidden">
                        <form id="markitdown-form" class="space-y-6">
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                <div class="flex items-start">
                                    <i class="fab fa-python text-purple-600 text-lg mt-1 mr-3"></i>
                                    <div>
                                        <h4 class="text-purple-900 font-medium">Microsoft Markitdown Integration</h4>
                                        <p class="text-purple-700 text-sm mt-1">Uses Microsoft's markitdown tool with conda environment support. Excellent for complex documents and web pages.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Mode Selection -->
                            <div class="bg-white border border-gray-200 rounded-lg p-4">
                                <label class="block text-sm font-medium text-gray-700 mb-3">Operation Mode</label>
                                <div class="grid grid-cols-3 gap-4">
                                    <label class="markitdown-mode-option relative border rounded-lg p-3 cursor-pointer hover:border-purple-300 transition-colors">
                                        <input type="radio" name="markitdown-mode" value="single" checked class="sr-only">
                                        <div class="text-center">
                                            <i class="fas fa-file-alt text-2xl text-gray-600 mb-2"></i>
                                            <p class="font-medium text-sm">Single URL</p>
                                            <p class="text-xs text-gray-500 mt-1">Extract one page</p>
                                        </div>
                                        <div class="markitdown-mode-indicator absolute inset-0 border-2 border-purple-500 rounded-lg hidden"></div>
                                    </label>
                                    <label class="markitdown-mode-option relative border rounded-lg p-3 cursor-pointer hover:border-purple-300 transition-colors">
                                        <input type="radio" name="markitdown-mode" value="batch" class="sr-only">
                                        <div class="text-center">
                                            <i class="fas fa-layer-group text-2xl text-gray-600 mb-2"></i>
                                            <p class="font-medium text-sm">Batch URLs</p>
                                            <p class="text-xs text-gray-500 mt-1">Extract multiple pages</p>
                                        </div>
                                        <div class="markitdown-mode-indicator absolute inset-0 border-2 border-purple-500 rounded-lg hidden"></div>
                                    </label>
                                    <label class="markitdown-mode-option relative border rounded-lg p-3 cursor-pointer hover:border-purple-300 transition-colors">
                                        <input type="radio" name="markitdown-mode" value="map" class="sr-only">
                                        <div class="text-center">
                                            <i class="fas fa-sitemap text-2xl text-gray-600 mb-2"></i>
                                            <p class="font-medium text-sm">Map Website</p>
                                            <p class="text-xs text-gray-500 mt-1">Extract all URLs</p>
                                        </div>
                                        <div class="markitdown-mode-indicator absolute inset-0 border-2 border-purple-500 rounded-lg hidden"></div>
                                    </label>
                                </div>
                            </div>

                            <!-- Dynamic Content Area -->
                            <div id="markitdown-dynamic-content">
                                <!-- Single URL Mode (default) -->
                                <div id="markitdown-single-mode" class="markitdown-mode-content">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            URL to Extract
                                        </label>
                                        <input type="url" id="markitdown-single-url" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors" placeholder="https://docs.example.com/guide">
                                    </div>
                                </div>

                                <!-- Batch URLs Mode -->
                                <div id="markitdown-batch-mode" class="markitdown-mode-content hidden">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            URLs to Extract (one per line)
                                        </label>
                                        <textarea id="markitdown-batch-urls" rows="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors" placeholder="https://example.com/page1&#10;https://example.com/page2&#10;https://example.com/page3"></textarea>
                                        <p class="mt-1 text-sm text-gray-500">Enter multiple URLs, one per line. Maximum 25 URLs per batch.</p>
                                    </div>
                                </div>

                                <!-- Map Website Mode -->
                                <div id="markitdown-map-mode" class="markitdown-mode-content hidden">
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Website URL to Map
                                            </label>
                                            <input type="url" id="markitdown-map-url" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors" placeholder="https://example.com">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Search Filter (optional)
                                            </label>
                                            <input type="text" id="markitdown-map-search" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors" placeholder="e.g., docs, api, guide">
                                            <p class="mt-1 text-sm text-gray-500">Filter URLs containing specific keywords</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Limit (optional)
                                            </label>
                                            <input type="number" id="markitdown-map-limit" min="1" max="1000" placeholder="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Environment Configuration -->
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">
                                    <i class="fas fa-cog mr-2"></i>Environment Configuration
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Conda Environment -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Conda Environment</label>
                                        <input type="text" id="markitdown-condaEnv" value="py312-tools" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                        <p class="mt-1 text-xs text-gray-500">Name of the conda environment with markitdown installed</p>
                                    </div>

                                    <!-- Environment Check -->
                                    <div class="flex items-end">
                                        <button type="button" id="check-env-btn" class="px-4 py-2 bg-gray-600 text-white font-medium rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors">
                                            <i class="fas fa-check-circle mr-2"></i>Check Environment
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Environment Status -->
                                <div id="env-status" class="mt-4 hidden">
                                    <div class="p-3 rounded-lg">
                                        <div id="env-status-content"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Markitdown Options -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Content Extraction Options -->
                                <div class="space-y-3">
                                    <h4 class="text-sm font-medium text-gray-700">Content Extraction</h4>
                                    <label class="flex items-center space-x-3">
                                        <input type="checkbox" id="markitdown-extractImages" checked class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                        <span class="text-sm font-medium text-gray-700">Extract Images</span>
                                    </label>
                                    <label class="flex items-center space-x-3">
                                        <input type="checkbox" id="markitdown-extractLinks" checked class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                        <span class="text-sm font-medium text-gray-700">Extract Links</span>
                                    </label>
                                    <label class="flex items-center space-x-3">
                                        <input type="checkbox" id="markitdown-extractTables" checked class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                        <span class="text-sm font-medium text-gray-700">Extract Tables</span>
                                    </label>
                                </div>

                                <!-- Timing Options -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Command Timeout (seconds)</label>
                                    <input type="number" id="markitdown-customTimeout" placeholder="Default: system timeout" min="10" max="300" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                    <p class="mt-1 text-xs text-gray-500">Timeout for the markitdown command execution</p>
                                </div>

                                <!-- User Agent -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Custom User Agent</label>
                                    <input type="text" id="markitdown-userAgent" placeholder="Default user agent" maxlength="200" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                    <p class="mt-1 text-xs text-gray-500">Optional custom user agent string</p>
                                </div>

                                <!-- Processing Timeout -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Processing Timeout (ms)</label>
                                    <input type="number" id="markitdown-timeout" value="60000" min="30000" max="300000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                    <p class="mt-1 text-xs text-gray-500">Overall timeout for the entire process</p>
                                </div>

                                <!-- Save Options -->
                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="markitdown-saveToFile" class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                    <label for="markitdown-saveToFile" class="text-sm font-medium text-gray-700">
                                        <span id="markitdown-save-label">Save to file</span>
                                    </label>
                                </div>

                                <!-- Save Directory -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Save Directory</label>
                                    <input type="text" id="markitdown-saveDirectory" placeholder="Leave empty for date-based folder" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="flex justify-end">
                                <button type="submit" id="markitdown-submit-btn" class="px-6 py-3 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-colors">
                                    <i class="fab fa-python mr-2"></i><span id="markitdown-submit-text">Extract with Markitdown</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Progress Section -->
            <div id="progress-section" class="hidden mt-6 bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Processing Progress</h3>
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Progress</span>
                        <span id="progress-text" class="text-gray-900 font-medium">0 / 0</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                <div id="current-url" class="mt-4 text-sm text-gray-600"></div>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="hidden mt-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Results</h3>
                        <button id="clear-results-btn" class="text-sm text-red-600 hover:text-red-700 font-medium">
                            <i class="fas fa-trash mr-1"></i>Clear All
                        </button>
                    </div>
                    <div id="results-container" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar">
                        <!-- Results will be inserted here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let isProcessing = false;
        let abortController = null;
        
        // Safe base64 encoding function that handles Unicode characters
        function safeBase64Encode(str) {
            try {
                // First encode as UTF-8, then base64
                return btoa(unescape(encodeURIComponent(str)));
            } catch (error) {
                console.warn('Failed to encode content for view:', error);
                return btoa('Content contains special characters that cannot be displayed.');
            }
        }
        
        // Safe base64 decoding function that handles Unicode characters
        function safeBase64Decode(str) {
            try {
                // First decode base64, then decode UTF-8
                return decodeURIComponent(escape(atob(str)));
            } catch (error) {
                console.warn('Failed to decode content for view:', error);
                return 'Content contains special characters that cannot be displayed.';
            }
        }

        // Initialize event listeners when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Tab switching
            document.getElementById('single-tab').addEventListener('click', () => switchTab('single'));
            document.getElementById('batch-tab').addEventListener('click', () => switchTab('batch'));
            document.getElementById('firecrawl-tab').addEventListener('click', () => switchTab('firecrawl'));
            document.getElementById('markitdown-tab').addEventListener('click', () => switchTab('markitdown'));
            
            // Clear results button
            document.getElementById('clear-results-btn').addEventListener('click', clearResults);
        });

        // Tab switching
        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(t => {
                t.classList.remove('border-blue-500', 'text-blue-600');
                t.classList.add('border-transparent', 'text-gray-500');
            });
            
            contents.forEach(c => c.classList.add('hidden'));
            
            const activeTab = document.getElementById(`${tab}-tab`);
            const activeContent = document.getElementById(`${tab}-content`);
            
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-blue-500', 'text-blue-600');
            activeContent.classList.remove('hidden');
        }

        // Form submission
        document.getElementById('single-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (isProcessing) {
                stopProcessing();
                return;
            }
            
            const urlsText = document.getElementById('urls-input').value.trim();
            if (!urlsText) {
                alert('Please enter at least one URL');
                return;
            }
            
            const urls = urlsText.split('\n').filter(url => url.trim());
            startProcessing(urls);
        });

        // Firecrawl mode switching
        const firecrawlModeRadios = document.querySelectorAll('input[name="firecrawl-mode"]');
        firecrawlModeRadios.forEach(radio => {
            radio.addEventListener('change', handleFirecrawlModeChange);
        });
        
        // Initialize first mode
        handleFirecrawlModeChange();
        
        function handleFirecrawlModeChange() {
            const selectedMode = document.querySelector('input[name="firecrawl-mode"]:checked').value;
            
            // Update UI indicators
            document.querySelectorAll('.firecrawl-mode-option').forEach(option => {
                const indicator = option.querySelector('.firecrawl-mode-indicator');
                const radio = option.querySelector('input[type="radio"]');
                if (radio.checked) {
                    indicator.classList.remove('hidden');
                    option.classList.add('border-orange-500');
                } else {
                    indicator.classList.add('hidden');
                    option.classList.remove('border-orange-500');
                }
            });
            
            // Show/hide content areas
            document.querySelectorAll('.firecrawl-mode-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            const saveLabel = document.getElementById('firecrawl-save-label');
            const submitText = document.getElementById('firecrawl-submit-text');
            
            switch(selectedMode) {
                case 'single':
                    document.getElementById('firecrawl-single-mode').classList.remove('hidden');
                    saveLabel.textContent = 'Save to file';
                    submitText.textContent = 'Extract with Firecrawl';
                    break;
                case 'batch':
                    document.getElementById('firecrawl-batch-mode').classList.remove('hidden');
                    saveLabel.textContent = 'Save to files';
                    submitText.textContent = 'Extract Batch with Firecrawl';
                    break;
                case 'map':
                    document.getElementById('firecrawl-map-mode').classList.remove('hidden');
                    saveLabel.textContent = 'Save to file';
                    submitText.textContent = 'Map Website with Firecrawl';
                    break;
            }
        }
        
        // Firecrawl form submission
        document.getElementById('firecrawl-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (isProcessing) {
                stopFirecrawlProcessing();
                return;
            }
            
            const selectedMode = document.querySelector('input[name="firecrawl-mode"]:checked').value;
            
            switch(selectedMode) {
                case 'single':
                    const singleUrl = document.getElementById('firecrawl-single-url').value.trim();
                    if (!singleUrl) {
                        alert('Please enter a URL');
                        return;
                    }
                    startFirecrawlProcessing(singleUrl);
                    break;
                    
                case 'batch':
                    const batchUrls = document.getElementById('firecrawl-batch-urls').value.trim();
                    if (!batchUrls) {
                        alert('Please enter at least one URL');
                        return;
                    }
                    const urls = batchUrls.split('\n').filter(url => url.trim());
                    if (urls.length > 25) {
                        alert('Maximum 25 URLs allowed per batch');
                        return;
                    }
                    startFirecrawlBatchProcessing(urls);
                    break;
                    
                case 'map':
                    const mapUrl = document.getElementById('firecrawl-map-url').value.trim();
                    if (!mapUrl) {
                        alert('Please enter a website URL to map');
                        return;
                    }
                    startFirecrawlMapProcessing(mapUrl);
                    break;
            }
        });

        // Markitdown mode switching
        const markitdownModeRadios = document.querySelectorAll('input[name="markitdown-mode"]');
        markitdownModeRadios.forEach(radio => {
            radio.addEventListener('change', handleMarkitdownModeChange);
        });
        
        // Initialize first mode
        handleMarkitdownModeChange();
        
        function handleMarkitdownModeChange() {
            const selectedMode = document.querySelector('input[name="markitdown-mode"]:checked').value;
            
            // Update UI indicators
            document.querySelectorAll('.markitdown-mode-option').forEach(option => {
                const indicator = option.querySelector('.markitdown-mode-indicator');
                const radio = option.querySelector('input[type="radio"]');
                if (radio.checked) {
                    indicator.classList.remove('hidden');
                    option.classList.add('border-purple-500');
                } else {
                    indicator.classList.add('hidden');
                    option.classList.remove('border-purple-500');
                }
            });
            
            // Show/hide content areas
            document.querySelectorAll('.markitdown-mode-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            const saveLabel = document.getElementById('markitdown-save-label');
            const submitText = document.getElementById('markitdown-submit-text');
            
            switch(selectedMode) {
                case 'single':
                    document.getElementById('markitdown-single-mode').classList.remove('hidden');
                    saveLabel.textContent = 'Save to file';
                    submitText.textContent = 'Extract with Markitdown';
                    break;
                case 'batch':
                    document.getElementById('markitdown-batch-mode').classList.remove('hidden');
                    saveLabel.textContent = 'Save to files';
                    submitText.textContent = 'Extract Batch with Markitdown';
                    break;
                case 'map':
                    document.getElementById('markitdown-map-mode').classList.remove('hidden');
                    saveLabel.textContent = 'Save to file';
                    submitText.textContent = 'Map Website with Markitdown';
                    break;
            }
        }
        
        // Markitdown form submission
        document.getElementById('markitdown-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (isProcessing) {
                stopMarkitdownProcessing();
                return;
            }
            
            const selectedMode = document.querySelector('input[name="markitdown-mode"]:checked').value;
            
            switch(selectedMode) {
                case 'single':
                    const singleUrl = document.getElementById('markitdown-single-url').value.trim();
                    if (!singleUrl) {
                        alert('Please enter a URL');
                        return;
                    }
                    startMarkitdownProcessing(singleUrl);
                    break;
                    
                case 'batch':
                    const batchUrls = document.getElementById('markitdown-batch-urls').value.trim();
                    if (!batchUrls) {
                        alert('Please enter at least one URL');
                        return;
                    }
                    const urls = batchUrls.split('\n').filter(url => url.trim());
                    if (urls.length > 25) {
                        alert('Maximum 25 URLs allowed per batch');
                        return;
                    }
                    startMarkitdownBatchProcessing(urls);
                    break;
                    
                case 'map':
                    const mapUrl = document.getElementById('markitdown-map-url').value.trim();
                    if (!mapUrl) {
                        alert('Please enter a website URL to map');
                        return;
                    }
                    startMarkitdownMapProcessing(mapUrl);
                    break;
            }
        });

        // Environment check
        document.getElementById('check-env-btn').addEventListener('click', async () => {
            const condaEnv = document.getElementById('markitdown-condaEnv').value.trim();
            if (!condaEnv) {
                alert('Please enter a conda environment name');
                return;
            }
            
            await checkMarkitdownEnvironment(condaEnv);
        });

        async function startProcessing(urls) {
            isProcessing = true;
            abortController = new AbortController();
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.innerHTML = '<i class="fas fa-stop mr-2"></i>Stop Processing';
            submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            submitBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            
            document.getElementById('progress-section').classList.remove('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            
            let completed = 0;
            updateProgress(completed, urls.length);
            
            for (let i = 0; i < urls.length; i++) {
                if (abortController.signal.aborted) break;
                
                const url = urls[i].trim();
                if (!url) continue;
                
                document.getElementById('current-url').innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Processing: ${url}`;
                
                try {
                    const result = await extractContent(url, abortController.signal);
                    addResult(result, 'success');
                } catch (error) {
                    if (error.name === 'AbortError') break;
                    addResult({ url, error: error.message }, 'error');
                }
                
                completed++;
                updateProgress(completed, urls.length);
                
                // Wait 1 second before next request (except for the last one)
                if (i < urls.length - 1 && !abortController.signal.aborted) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            stopProcessing();
        }

        function stopProcessing() {
            isProcessing = false;
            if (abortController) {
                abortController.abort();
            }
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Start Extraction';
            submitBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            
            document.getElementById('current-url').innerHTML = '<i class="fas fa-check-circle text-green-600 mr-2"></i>Processing complete';
        }

        async function extractContent(url, signal) {
            const options = {
                format: document.getElementById('format').value,
                includeImages: document.getElementById('includeImages').checked,
                includeLinks: document.getElementById('includeLinks').checked,
                timeout: parseInt(document.getElementById('timeout').value),
                saveToFile: document.getElementById('saveToFile').checked,
                // Advanced options
                waitTime: parseInt(document.getElementById('waitTime').value),
                waitUntil: document.getElementById('waitUntil').value,
                waitForContentSelectors: document.getElementById('waitForContentSelectors').checked,
                scrollToBottom: document.getElementById('scrollToBottom').checked,
                maxContentLength: parseInt(document.getElementById('maxContentLength').value)
            };
            
            const waitForSelector = document.getElementById('waitForSelector').value.trim();
            if (waitForSelector) {
                options.waitForSelector = waitForSelector;
            }
            
            const saveDirectory = document.getElementById('saveDirectory').value.trim();
            if (saveDirectory) {
                options.saveDirectory = saveDirectory;
            }
            
            const response = await fetch('/api/extract', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url, options }),
                signal
            });
            
            const data = await response.json();
            
            if (!response.ok || !data.success) {
                throw new Error(data.error?.message || 'Extraction failed');
            }
            
            return data.data;
        }

        function updateProgress(completed, total) {
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${completed} / ${total}`;
        }

        function addResult(data, status) {
            const container = document.getElementById('results-container');
            const resultDiv = document.createElement('div');
            
            if (status === 'success') {
                resultDiv.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50';
                resultDiv.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900 mb-1">${data.title || 'Untitled'}</h4>
                            <p class="text-sm text-gray-600 mb-2">${data.url}</p>
                            <div class="flex items-center space-x-4 text-xs text-gray-500">
                                <span><i class="fas fa-clock mr-1"></i>${data.metadata?.processingTime || 0}ms</span>
                                <span><i class="fas fa-file-alt mr-1"></i>${data.metadata?.wordCount || 0} words</span>
                                ${data.savedFilePath ? `<span class="text-green-600"><i class="fas fa-save mr-1"></i>${data.savedFilePath}</span>` : ''}
                            </div>
                        </div>
                        <button data-content="${safeBase64Encode(data.markdown || '')}" class="view-btn ml-4 px-3 py-1 bg-blue-100 text-blue-700 text-sm font-medium rounded hover:bg-blue-200 transition-colors">
                            <i class="fas fa-eye mr-1"></i>View
                        </button>
                    </div>
                `;
            } else {
                resultDiv.className = 'border border-red-200 rounded-lg p-4 bg-red-50';
                resultDiv.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle text-red-600 mr-3"></i>
                        <div>
                            <p class="font-medium text-red-900">${data.url}</p>
                            <p class="text-sm text-red-700 mt-1">${data.error}</p>
                        </div>
                    </div>
                `;
            }
            
            container.insertBefore(resultDiv, container.firstChild);
            
            // Add event listener to the new view button
            const viewBtn = resultDiv.querySelector('.view-btn');
            if (viewBtn) {
                viewBtn.addEventListener('click', (e) => {
                    const content = e.currentTarget.getAttribute('data-content');
                    viewContent(content);
                });
            }
        }

        function viewContent(encodedContent) {
            const content = safeBase64Decode(encodedContent);
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl w-full max-h-[80vh] flex flex-col">
                    <div class="flex items-center justify-between p-4 border-b">
                        <h3 class="text-lg font-semibold">Extracted Content</h3>
                        <button class="modal-close text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="p-4 overflow-y-auto flex-1">
                        <pre class="whitespace-pre-wrap text-sm text-gray-700">${content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listener to close button
            modal.querySelector('.modal-close').addEventListener('click', () => {
                modal.remove();
            });
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        async function startFirecrawlProcessing(url) {
            isProcessing = true;
            abortController = new AbortController();
            
            const submitBtn = document.getElementById('firecrawl-submit-btn');
            submitBtn.innerHTML = '<i class="fas fa-stop mr-2"></i>Stop Processing';
            submitBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
            submitBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            
            document.getElementById('progress-section').classList.remove('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            
            updateProgress(0, 1);
            document.getElementById('current-url').innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Processing with Firecrawl: ${url}`;
            
            try {
                const result = await extractFirecrawlContent(url, abortController.signal);
                addResult(result, 'success');
                updateProgress(1, 1);
            } catch (error) {
                if (error.name === 'AbortError') return;
                addResult({ url, error: error.message }, 'error');
                updateProgress(1, 1);
            }
            
            stopFirecrawlProcessing();
        }

        function stopFirecrawlProcessing() {
            isProcessing = false;
            if (abortController) {
                abortController.abort();
            }
            
            const submitBtn = document.getElementById('firecrawl-submit-btn');
            submitBtn.innerHTML = '<i class="fas fa-fire mr-2"></i>Extract with Firecrawl';
            submitBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            submitBtn.classList.add('bg-orange-600', 'hover:bg-orange-700');
            
            document.getElementById('current-url').innerHTML = '<i class="fas fa-check-circle text-green-600 mr-2"></i>Firecrawl processing complete';
        }

        async function extractFirecrawlContent(url, signal) {
            const formats = [];
            if (document.getElementById('firecrawl-markdown').checked) formats.push('markdown');
            if (document.getElementById('firecrawl-html').checked) formats.push('html');
            
            const includeTags = document.getElementById('firecrawl-includeTags').value.trim()
                .split(',').map(tag => tag.trim()).filter(tag => tag);
            const excludeTags = document.getElementById('firecrawl-excludeTags').value.trim()
                .split(',').map(tag => tag.trim()).filter(tag => tag);
            
            const options = {
                formats: formats.length > 0 ? formats : ['markdown'],
                onlyMainContent: document.getElementById('firecrawl-onlyMainContent').checked,
                waitFor: parseInt(document.getElementById('firecrawl-waitFor').value),
                timeout: parseInt(document.getElementById('firecrawl-timeout').value),
                screenshot: document.getElementById('firecrawl-screenshot').checked,
                saveToFile: document.getElementById('firecrawl-saveToFile').checked,
                ...(includeTags.length > 0 && { includeTags }),
                ...(excludeTags.length > 0 && { excludeTags })
            };
            
            const saveDirectory = document.getElementById('firecrawl-saveDirectory').value.trim();
            if (saveDirectory) {
                options.saveDirectory = saveDirectory;
            }
            
            const response = await fetch('/api/firecrawl/extract', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url, options }),
                signal
            });
            
            const data = await response.json();
            
            if (!response.ok || !data.success) {
                throw new Error(data.error?.message || 'Firecrawl extraction failed');
            }
            
            return data.data;
        }
        
        async function startFirecrawlBatchProcessing(urls) {
            isProcessing = true;
            abortController = new AbortController();
            
            const submitBtn = document.getElementById('firecrawl-submit-btn');
            submitBtn.innerHTML = '<i class="fas fa-stop mr-2"></i>Stop Processing';
            submitBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
            submitBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            
            document.getElementById('progress-section').classList.remove('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            
            updateProgress(0, urls.length);
            document.getElementById('current-url').innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Processing batch with Firecrawl...`;
            
            try {
                const formats = [];
                if (document.getElementById('firecrawl-markdown').checked) formats.push('markdown');
                if (document.getElementById('firecrawl-html').checked) formats.push('html');
                
                const includeTags = document.getElementById('firecrawl-includeTags').value.trim()
                    .split(',').map(tag => tag.trim()).filter(tag => tag);
                const excludeTags = document.getElementById('firecrawl-excludeTags').value.trim()
                    .split(',').map(tag => tag.trim()).filter(tag => tag);
                
                const options = {
                    concurrent: 3,
                    formats: formats.length > 0 ? formats : ['markdown'],
                    onlyMainContent: document.getElementById('firecrawl-onlyMainContent').checked,
                    waitFor: parseInt(document.getElementById('firecrawl-waitFor').value),
                    timeout: parseInt(document.getElementById('firecrawl-timeout').value),
                    screenshot: document.getElementById('firecrawl-screenshot').checked,
                    saveToFile: document.getElementById('firecrawl-saveToFile').checked,
                    ...(includeTags.length > 0 && { includeTags }),
                    ...(excludeTags.length > 0 && { excludeTags })
                };
                
                const saveDirectory = document.getElementById('firecrawl-saveDirectory').value.trim();
                if (saveDirectory) {
                    options.saveDirectory = saveDirectory;
                }
                
                const response = await fetch('/api/firecrawl/batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ urls, options }),
                    signal: abortController.signal
                });
                
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    throw new Error(data.error?.message || 'Batch processing failed');
                }
                
                // Process results
                data.data.results.forEach((result, index) => {
                    if (result.success) {
                        addResult(result.data, 'success');
                    } else {
                        addResult({ url: urls[index], error: result.error.message }, 'error');
                    }
                    updateProgress(index + 1, urls.length);
                });
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    alert('Batch processing failed: ' + error.message);
                }
            }
            
            stopFirecrawlProcessing();
        }
        
        async function startFirecrawlMapProcessing(url) {
            isProcessing = true;
            abortController = new AbortController();
            
            const submitBtn = document.getElementById('firecrawl-submit-btn');
            submitBtn.innerHTML = '<i class="fas fa-stop mr-2"></i>Stop Mapping';
            submitBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
            submitBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            
            document.getElementById('progress-section').classList.remove('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            
            updateProgress(0, 1);
            document.getElementById('current-url').innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Mapping website: ${url}`;
            
            try {
                const search = document.getElementById('firecrawl-map-search').value.trim();
                const limit = document.getElementById('firecrawl-map-limit').value;
                
                const options = {
                    saveToFile: document.getElementById('firecrawl-saveToFile').checked,
                    ...(search && { search }),
                    ...(limit && { limit: parseInt(limit) })
                };
                
                const saveDirectory = document.getElementById('firecrawl-saveDirectory').value.trim();
                if (saveDirectory) {
                    options.saveDirectory = saveDirectory;
                }
                
                const response = await fetch('/api/firecrawl/map', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url, options }),
                    signal: abortController.signal
                });
                
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    throw new Error(data.error?.message || 'Website mapping failed');
                }
                
                // Display map results
                const mapResult = {
                    url: data.data.baseUrl,
                    title: `Website Map - ${data.data.summary.totalLinks} URLs found`,
                    markdown: data.data.links.join('\n'),
                    metadata: {
                        processingTime: data.data.summary.processingTime,
                        wordCount: data.data.summary.totalLinks,
                        search: data.data.summary.search
                    },
                    savedFilePath: data.data.savedFilePath
                };
                
                addResult(mapResult, 'success');
                updateProgress(1, 1);
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    addResult({ url, error: error.message }, 'error');
                    updateProgress(1, 1);
                }
            }
            
            stopFirecrawlProcessing();
        }

        async function startMarkitdownProcessing(url) {
            isProcessing = true;
            abortController = new AbortController();
            
            const submitBtn = document.getElementById('markitdown-submit-btn');
            submitBtn.innerHTML = '<i class="fas fa-stop mr-2"></i>Stop Processing';
            submitBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            submitBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            
            document.getElementById('progress-section').classList.remove('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            
            updateProgress(0, 1);
            document.getElementById('current-url').innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Processing with Markitdown: ${url}`;
            
            try {
                const result = await extractMarkitdownContent(url, abortController.signal);
                addResult(result, 'success');
                updateProgress(1, 1);
            } catch (error) {
                if (error.name === 'AbortError') return;
                addResult({ url, error: error.message }, 'error');
                updateProgress(1, 1);
            }
            
            stopMarkitdownProcessing();
        }

        function stopMarkitdownProcessing() {
            isProcessing = false;
            if (abortController) {
                abortController.abort();
            }
            
            const submitBtn = document.getElementById('markitdown-submit-btn');
            submitBtn.innerHTML = '<i class="fab fa-python mr-2"></i>Extract with Markitdown';
            submitBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            submitBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
            
            document.getElementById('current-url').innerHTML = '<i class="fas fa-check-circle text-green-600 mr-2"></i>Markitdown processing complete';
        }

        async function extractMarkitdownContent(url, signal) {
            const condaEnv = document.getElementById('markitdown-condaEnv').value.trim();
            const customTimeout = document.getElementById('markitdown-customTimeout').value;
            const userAgent = document.getElementById('markitdown-userAgent').value.trim();
            
            const options = {
                condaEnv: condaEnv || 'py312-tools',
                extractImages: document.getElementById('markitdown-extractImages').checked,
                extractLinks: document.getElementById('markitdown-extractLinks').checked,
                extractTables: document.getElementById('markitdown-extractTables').checked,
                timeout: parseInt(document.getElementById('markitdown-timeout').value),
                saveToFile: document.getElementById('markitdown-saveToFile').checked,
                ...(customTimeout && { customTimeout: parseInt(customTimeout) }),
                ...(userAgent && { userAgent })
            };
            
            const saveDirectory = document.getElementById('markitdown-saveDirectory').value.trim();
            if (saveDirectory) {
                options.saveDirectory = saveDirectory;
            }
            
            const response = await fetch('/api/markitdown/extract', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url, options }),
                signal
            });
            
            const data = await response.json();
            
            if (!response.ok || !data.success) {
                throw new Error(data.error?.message || 'Markitdown extraction failed');
            }
            
            return data.data;
        }
        
        async function startMarkitdownBatchProcessing(urls) {
            isProcessing = true;
            abortController = new AbortController();
            
            const submitBtn = document.getElementById('markitdown-submit-btn');
            submitBtn.innerHTML = '<i class="fas fa-stop mr-2"></i>Stop Processing';
            submitBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            submitBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            
            document.getElementById('progress-section').classList.remove('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            
            updateProgress(0, urls.length);
            document.getElementById('current-url').innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Processing batch with Markitdown...`;
            
            try {
                const condaEnv = document.getElementById('markitdown-condaEnv').value.trim();
                const customTimeout = document.getElementById('markitdown-customTimeout').value;
                const userAgent = document.getElementById('markitdown-userAgent').value.trim();
                
                const options = {
                    concurrent: 3,
                    condaEnv: condaEnv || 'py312-tools',
                    extractImages: document.getElementById('markitdown-extractImages').checked,
                    extractLinks: document.getElementById('markitdown-extractLinks').checked,
                    extractTables: document.getElementById('markitdown-extractTables').checked,
                    timeout: parseInt(document.getElementById('markitdown-timeout').value),
                    saveToFile: document.getElementById('markitdown-saveToFile').checked,
                    ...(customTimeout && { customTimeout: parseInt(customTimeout) }),
                    ...(userAgent && { userAgent })
                };
                
                const saveDirectory = document.getElementById('markitdown-saveDirectory').value.trim();
                if (saveDirectory) {
                    options.saveDirectory = saveDirectory;
                }
                
                const response = await fetch('/api/markitdown/batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ urls, options }),
                    signal: abortController.signal
                });
                
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    throw new Error(data.error?.message || 'Batch processing failed');
                }
                
                // Process results
                data.data.results.forEach((result, index) => {
                    if (result.success) {
                        addResult(result.data, 'success');
                    } else {
                        addResult({ url: urls[index], error: result.error.message }, 'error');
                    }
                    updateProgress(index + 1, urls.length);
                });
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    alert('Batch processing failed: ' + error.message);
                }
            }
            
            stopMarkitdownProcessing();
        }
        
        async function startMarkitdownMapProcessing(url) {
            isProcessing = true;
            abortController = new AbortController();
            
            const submitBtn = document.getElementById('markitdown-submit-btn');
            submitBtn.innerHTML = '<i class="fas fa-stop mr-2"></i>Stop Mapping';
            submitBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            submitBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            
            document.getElementById('progress-section').classList.remove('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            
            updateProgress(0, 1);
            document.getElementById('current-url').innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Mapping website: ${url}`;
            
            try {
                const search = document.getElementById('markitdown-map-search').value.trim();
                const limit = document.getElementById('markitdown-map-limit').value;
                const condaEnv = document.getElementById('markitdown-condaEnv').value.trim();
                const customTimeout = document.getElementById('markitdown-customTimeout').value;
                const userAgent = document.getElementById('markitdown-userAgent').value.trim();
                
                const options = {
                    condaEnv: condaEnv || 'py312-tools',
                    extractImages: document.getElementById('markitdown-extractImages').checked,
                    extractLinks: document.getElementById('markitdown-extractLinks').checked,
                    extractTables: document.getElementById('markitdown-extractTables').checked,
                    timeout: parseInt(document.getElementById('markitdown-timeout').value),
                    saveToFile: document.getElementById('markitdown-saveToFile').checked,
                    ...(search && { search }),
                    ...(limit && { limit: parseInt(limit) }),
                    ...(customTimeout && { customTimeout: parseInt(customTimeout) }),
                    ...(userAgent && { userAgent })
                };
                
                const saveDirectory = document.getElementById('markitdown-saveDirectory').value.trim();
                if (saveDirectory) {
                    options.saveDirectory = saveDirectory;
                }
                
                const response = await fetch('/api/markitdown/map', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url, options }),
                    signal: abortController.signal
                });
                
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    throw new Error(data.error?.message || 'Website mapping failed');
                }
                
                // Display map results
                const mapResult = {
                    url: data.data.baseUrl,
                    title: `Website Map - ${data.data.summary.totalLinks} URLs found (${data.data.summary.totalFound} total)`,
                    markdown: data.data.links.join('\n'),
                    metadata: {
                        processingTime: data.data.summary.processingTime,
                        wordCount: data.data.summary.totalLinks,
                        search: data.data.summary.search
                    },
                    savedFilePath: data.data.savedFilePath
                };
                
                addResult(mapResult, 'success');
                updateProgress(1, 1);
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    addResult({ url, error: error.message }, 'error');
                    updateProgress(1, 1);
                }
            }
            
            stopMarkitdownProcessing();
        }

        async function checkMarkitdownEnvironment(condaEnv) {
            const checkBtn = document.getElementById('check-env-btn');
            const statusDiv = document.getElementById('env-status');
            const statusContent = document.getElementById('env-status-content');
            
            // Show loading state
            checkBtn.disabled = true;
            checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Checking...';
            
            try {
                const response = await fetch('/api/markitdown/check-env', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ condaEnv })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const result = data.data;
                    let statusClass, statusIcon, statusText;
                    
                    if (result.overall === 'ready') {
                        statusClass = 'bg-green-50 border-green-200 text-green-800';
                        statusIcon = 'fas fa-check-circle text-green-600';
                        statusText = 'Environment is ready!';
                    } else {
                        statusClass = 'bg-red-50 border-red-200 text-red-800';
                        statusIcon = 'fas fa-exclamation-circle text-red-600';
                        statusText = 'Environment has issues';
                    }
                    
                    statusDiv.className = `mt-4 p-3 rounded-lg border ${statusClass}`;
                    statusDiv.classList.remove('hidden');
                    
                    statusContent.innerHTML = `
                        <div class="flex items-start space-x-3">
                            <i class="${statusIcon} mt-1"></i>
                            <div class="flex-1">
                                <h5 class="font-medium">${statusText}</h5>
                                <div class="mt-2 text-sm space-y-1">
                                    <div>
                                        <strong>Environment "${condaEnv}":</strong> 
                                        ${result.environment.exists ? 
                                            '<span class="text-green-600"> Found</span>' : 
                                            '<span class="text-red-600"> Not found</span>'
                                        }
                                    </div>
                                    <div>
                                        <strong>Markitdown:</strong> 
                                        ${result.markitdown.installed ? 
                                            `<span class="text-green-600"> Installed (${result.markitdown.version})</span>` : 
                                            '<span class="text-red-600"> Not installed</span>'
                                        }
                                    </div>
                                    ${(!result.environment.exists || !result.markitdown.installed) ? `
                                        <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-yellow-800 text-xs">
                                            <strong>Setup Instructions:</strong><br>
                                            ${!result.environment.exists ? ` Create conda environment: <code>conda create -n ${condaEnv} python=3.12</code><br>` : ''}
                                            ${!result.markitdown.installed ? ` Install markitdown: <code>conda activate ${condaEnv} && pip install markitdown</code>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    statusDiv.className = 'mt-4 p-3 rounded-lg border bg-red-50 border-red-200 text-red-800';
                    statusDiv.classList.remove('hidden');
                    statusContent.innerHTML = `
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-exclamation-triangle text-red-600 mt-1"></i>
                            <div>
                                <h5 class="font-medium">Check failed</h5>
                                <p class="text-sm mt-1">${data.error?.message || 'Unknown error occurred'}</p>
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                statusDiv.className = 'mt-4 p-3 rounded-lg border bg-red-50 border-red-200 text-red-800';
                statusDiv.classList.remove('hidden');
                statusContent.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-exclamation-triangle text-red-600 mt-1"></i>
                        <div>
                            <h5 class="font-medium">Connection error</h5>
                            <p class="text-sm mt-1">${error.message}</p>
                        </div>
                    </div>
                `;
            } finally {
                // Reset button state
                checkBtn.disabled = false;
                checkBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Check Environment';
            }
        }

        function clearResults() {
            if (confirm('Clear all results?')) {
                document.getElementById('results-container').innerHTML = '';
                document.getElementById('results-section').classList.add('hidden');
                document.getElementById('progress-section').classList.add('hidden');
            }
        }
    </script>
</body>
</html>